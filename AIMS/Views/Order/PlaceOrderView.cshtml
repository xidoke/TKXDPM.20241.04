@using AIMS.Data.Entities;
@model List<AIMS.Data.Entities.OrderMedia>

@{
    ViewBag.Title = "Đặt hàng";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storefront</title>
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="stylesheet" href="~/css/placeorder.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6">
                <div class="container-box">
                    <h2>Thông tin giao hàng</h2>
                    <form id="shippingForm">
                        <div class="form-group">
                            <label for="fullName">Họ và tên người nhận</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Số điện thoại</label>
                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="address">Địa chỉ</label>
                            <input type="text" class="form-control" id="address" name="address" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="province">Tỉnh/thành</label>
                            <select class="form-control" id="province" name="province" asp-items="ViewBag.Provinces">
                                <option value="">-- Chọn tỉnh/thành --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="district">Quận/huyện</label>
                            <select class="form-control" id="district" name="district">
                                <option value="">-- Chọn quận/huyện --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ward">Phường/xã</label>
                            <select class="form-control" id="ward" name="ward">
                                <option value="">-- Chọn phường/xã --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vận chuyển</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shippingMethod" id="standardShipping" value="standard" checked>
                                <label class="form-check-label" for="standardShipping">
                                    Vận chuyển thường (Nhận được sau 3 - 4 ngày)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shippingMethod" id="expressShipping" value="express">
                                <label class="form-check-label" for="expressShipping">
                                    Vận chuyển hỏa tốc
                                </label>
                            </div>
                        </div>
                        <div id="additionalFields" style="display: none;">
                            @* Initially hide the fields *@
                            <div class="form-group">
                                <label for="deliveryTime">Thời gian vận chuyển</label>
                                <input type="text" class="form-control" id="deliveryTime" name="deliveryTime" placeholder="Ex: Next day delivery">
                            </div>
                            <div class="form-group">
                                <label for="shipperNote">Lời nhắc cho người vận chuyển</label>
                                <textarea class="form-control" id="shipperNote" name="shipperNote" rows="3" placeholder="Ex: Fragile, handle with care"></textarea>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="button" class="btn btn-danger" id="cancelButton">Hủy</button>
                            <button type="button" class="btn btn-dark" id="saveShippingInfo">Lưu thông tin vận chuyển</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-6">
                <div class="container-box">
                    <h2>Đơn hàng</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Media ID</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th> @* Add a Total column *@
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.MediaId</td>
                                    <td>@item.Quantity</td>
                                    <td>@item.Price.ToString("C")</td>
                                    <td>(@(item.Quantity * item.Price)).ToString("C")</td> @* Calculate and display item total *@
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right">Grand Total:</td>
                                <td>@Model.Sum(item => item.Quantity * item.Price).ToString("C")</td> @* Calculate and display grand total *@
                            </tr>
                        </tfoot>
                    </table>

                    <div class="mt-4">
                        @* <p><b>Giá (Đã VAT):</b> <span id="grandTotal">@grandTotal.ToString("C")</span></p>
                        <p><b>Phí vận chuyển:</b> <span id="shippingFee">@shippingFee.ToString("C")</span></p> *@
                        <p id="shippingNote">(1 sản phẩm vận chuyển hỏa tốc)</p>
                    </div>

                    <div class="mt-4 text-right">
                        <button type="button" class="btn btn-danger" id="checkoutButton">Thanh toán</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            $(document).ready(function () {
                // Function to show/hide additional fields
                function toggleAdditionalFields() {
                    if ($("#expressShipping").is(":checked")) {
                        $("#additionalFields").show();
                    } else {
                        $("#additionalFields").hide();
                    }
                }

                // Call initially on page load
                toggleAdditionalFields();

                // Handle shipping method radio button change
                $("input[name='shippingMethod']").change(function () {
                    toggleAdditionalFields();
                });

                // Handle province selection change (same as before)
                $("#province").change(function () {
                    var provinceId = $(this).val();
                    if (provinceId) {
                        $.get("@Url.Action("GetDistrictsByProvince", "Order")", { provinceId: provinceId }, function (data) {
                            $("#district").empty().append($('<option>').text("-- Chọn quận/huyện --").attr('value', ''));
                            $.each(data, function (i, district) {
                                $("#district").append($('<option>').text(district.name).attr('value', district.id));
                            });
                            $("#ward").empty().append($('<option>').text("-- Chọn phường/xã --").attr('value', ''));
                        });
                    } else {
                        $("#district").empty().append($('<option>').text("-- Chọn quận/huyện --").attr('value', ''));
                        $("#ward").empty().append($('<option>').text("-- Chọn phường/xã --").attr('value', ''));
                    }
                });

                // Handle district selection change (same as before)
                $("#district").change(function () {
                    var districtId = $(this).val();
                    if (districtId) {
                        $.get("@Url.Action("GetWardsByDistrict", "Order")", { districtId: districtId }, function (data) {
                            $("#ward").empty().append($('<option>').text("-- Chọn phường/xã --").attr('value', ''));
                            $.each(data, function (i, ward) {
                                $("#ward").append($('<option>').text(ward.name).attr('value', ward.id));
                            });
                        });
                    } else {
                        $("#ward").empty().append($('<option>').text("-- Chọn phường/xã --").attr('value', ''));
                    }
                });

                // Handle saving shipping info (AJAX part - same as before)
                $("#saveShippingInfo").click(function () {
                    var shippingMethod = $("input[name='shippingMethod']:checked").val();

                    $.ajax({
                        url: "@Url.Action("UpdateShippingFee", "Order")",
                        type: "POST",
                        data: { shippingMethod: shippingMethod },
                        success: function (newShippingFee) {
                            $("#shippingFee").text(newShippingFee);

                            if (shippingMethod === "express") {
                                $("#shippingNote").text("(Vận chuyển hỏa tốc)");
                            } else {
                                $("#shippingNote").text("(Vận chuyển thường)");
                            }
                        },
                        error: function () {
                            alert("Error updating shipping fee.");
                        }
                    });
                });
            });
        </script>
    }
</body>
</html>